%% tls-cert-sequence-with-dns.mmd
%% Sequence diagram: TLS handshake inclusief DNS en certificaatvalidatie

sequenceDiagram
    autonumber
    participant U as Browser/Client
    participant DNS as DNS Resolver
    participant S as Website/Server (www.example.com)
    participant IC as Intermediate CA
    participant RC as Root CA (trust store)
    participant OCSP as OCSP/CRL Service

    U->>DNS: 1) DNS query: www.example.com
    DNS-->>U: 2) DNS response: IP address (A/AAAA) <br/>(optioneel DNSSEC validatie)

    U->>S: 3) ClientHello (SNI=www.example.com, ciphers, ALPN)
    S-->>U: 4) ServerHello + Certificate chain <br/>(ServerCert + Intermediate)

    Note over S,U: Server stuurt certificaatketen mee<br/>(Root CA niet meegestuurd)

    U->>U: 5) Controle CN/SAN = www.example.com
    U->>U: 6) Controle geldigheid (notBefore/notAfter)
    U->>U: 7) Verifieer handtekening ServerCert door Intermediate
    U->>U: 8) Verifieer Intermediate door Root CA
    U->>RC: 9) Root CA staat in trust store
    RC-->>U: 10) Root key = vertrouwd

    rect rgb(245,245,245)
    U->>OCSP: 11) Revocation check (OCSP/CRL)
    OCSP-->>U: 12) Status: good/revoked/unknown
    end

    alt Alles geldig
      U->>S: 13) Key Exchange / Finished
      Note over U,S: Sessiesleutels afgeleid
      U-->>S: 14) Versleuteld verkeer (HTTPS)
    else Ongeldig (DNS mismatch / revoked / verlopen)
      U->>U: Toon foutmelding & blokkeer verbinding
    end
